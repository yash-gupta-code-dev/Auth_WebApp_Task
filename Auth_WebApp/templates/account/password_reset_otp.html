{% extends "base.html" %}

{% block title %}Reset Password{% endblock %}

{% block content %}
<div class="row justify-content-center" style="min-height: 60vh; align-items: center;">
    <div class="col-md-5">
        <div class="card shadow-lg">
            <div class="card-body p-5">
                <h3 class="text-center mb-4">Reset Password</h3>

                <!-- STEP 1: Enter Email -->
                <div id="step-1">
                    <p class="text-muted text-center small mb-4">Enter your email address to receive a 6-digit OTP.</p>
                    <form id="request-otp-form">
                        <div class="mb-3">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="reset-email" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" id="btn-send-otp">Send OTP</button>
                        </div>
                    </form>
                </div>

                <!-- STEP 2: Enter OTP & New Password (Hidden initially) -->
                <div id="step-2" style="display: none;">
                    <div class="alert alert-success small">OTP sent! Please check your email (and spam folder).</div>
                    <form id="confirm-reset-form">
                        <div class="mb-3">
                            <label class="form-label">Enter 6-Digit OTP</label>
                            <input type="text" class="form-control fw-bold text-center" id="otp-input" placeholder="XXXXXX" maxlength="6" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">New Password</label>
                            <input type="password" class="form-control" id="new-password" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success">Change Password</button>
                        </div>
                    </form>
                </div>

                <div id="message-box" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let userEmail = "";

    // HANDLE STEP 1: REQUEST OTP
    document.getElementById('request-otp-form').addEventListener('submit', function(e) {
        e.preventDefault();
        userEmail = document.getElementById('reset-email').value;
        const btn = document.getElementById('btn-send-otp');
        const msgBox = document.getElementById('message-box');

        btn.disabled = true;
        btn.innerText = "Sending...";
        msgBox.innerHTML = "";

        fetch("{% url 'api_request_otp' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ email: userEmail })
        })
        .then(res => res.json())
        .then(data => {
            if (data.message) {
                // Show Step 2
                document.getElementById('step-1').style.display = 'none';
                document.getElementById('step-2').style.display = 'block';
            } else {
                msgBox.innerHTML = `<div class="alert alert-danger">${data.error || 'Error sending OTP'}</div>`;
                btn.disabled = false;
                btn.innerText = "Send OTP";
            }
        })
        .catch(err => {
            console.error(err);
            msgBox.innerHTML = `<div class="alert alert-danger">Network error.</div>`;
            btn.disabled = false;
            btn.innerText = "Send OTP";
        });
    });

    // HANDLE STEP 2: CONFIRM OTP & PASSWORD
    document.getElementById('confirm-reset-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const otp = document.getElementById('otp-input').value;
        const password = document.getElementById('new-password').value;
        const msgBox = document.getElementById('message-box');

        fetch("{% url 'api_confirm_otp' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ 
                email: userEmail, 
                otp: otp, 
                new_password: password 
            })
        })
        .then(res => {
            if(res.ok) {
                return res.json();
            } else {
                return res.json().then(err => { throw new Error(err.error) });
            }
        })
        .then(data => {
            document.getElementById('step-2').innerHTML = `
                <div class="alert alert-success text-center">
                    <h4>Success!</h4>
                    <p>${data.message}</p>
                    <a href="{% url 'account_login' %}" class="btn btn-primary mt-2">Login Now</a>
                </div>
            `;
            msgBox.innerHTML = "";
        })
        .catch(err => {
            msgBox.innerHTML = `<div class="alert alert-danger">${err.message || 'Invalid OTP'}</div>`;
        });
    });
</script>
{% endblock %}